{"ast":null,"code":"\"use strict\";\n/*!\n * Copyright 2018 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar node_fetch_1 = require(\"node-fetch\");\n\nvar stream_1 = require(\"stream\");\n\nvar uuid = require(\"uuid\");\n\nvar agents_1 = require(\"./agents\");\n\nvar streamEvents = require('stream-events');\n\nvar RequestError =\n/** @class */\nfunction (_super) {\n  __extends(RequestError, _super);\n\n  function RequestError() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n\n  return RequestError;\n}(Error);\n\nexports.RequestError = RequestError;\n/**\n * Convert options from Request to Fetch format\n * @private\n * @param reqOpts Request options\n */\n\nfunction requestToFetchOptions(reqOpts) {\n  var options = __assign(__assign({\n    method: reqOpts.method || 'GET'\n  }, reqOpts.timeout && {\n    timeout: reqOpts.timeout\n  }), typeof reqOpts.gzip === 'boolean' && {\n    compress: reqOpts.gzip\n  });\n\n  if (typeof reqOpts.json === 'object') {\n    // Add Content-type: application/json header\n    reqOpts.headers = reqOpts.headers || {};\n    reqOpts.headers['Content-Type'] = 'application/json'; // Set body to JSON representation of value\n\n    options.body = JSON.stringify(reqOpts.json);\n  } else {\n    if (typeof reqOpts.body !== 'string') {\n      options.body = JSON.stringify(reqOpts.body);\n    } else {\n      options.body = reqOpts.body;\n    }\n  } // tslint:disable-next-line no-any\n\n\n  options.headers = reqOpts.headers;\n  var uri = reqOpts.uri || reqOpts.url;\n\n  if (reqOpts.useQuerystring === true || typeof reqOpts.qs === 'object') {\n    var qs = require('querystring');\n\n    var params = qs.stringify(reqOpts.qs);\n    uri = uri + '?' + params;\n  }\n\n  options.agent = agents_1.getAgent(uri, reqOpts);\n  return {\n    uri: uri,\n    options: options\n  };\n}\n/**\n * Convert a response from `fetch` to `request` format.\n * @private\n * @param opts The `request` options used to create the request.\n * @param res The Fetch response\n * @returns A `request` response object\n */\n\n\nfunction fetchToRequestResponse(opts, res) {\n  var request = {};\n  request.agent = opts.agent || false;\n  request.headers = opts.headers || {};\n  request.href = res.url; // headers need to be converted from a map to an obj\n\n  var resHeaders = {};\n  res.headers.forEach(function (value, key) {\n    return resHeaders[key] = value;\n  });\n  var response = Object.assign(res.body, {\n    statusCode: res.status,\n    statusMessage: res.statusText,\n    request: request,\n    body: res.body,\n    headers: resHeaders,\n    toJSON: function () {\n      return {\n        headers: resHeaders\n      };\n    }\n  });\n  return response;\n}\n/**\n * Create POST body from two parts as multipart/related content-type\n * @private\n * @param boundary\n * @param multipart\n */\n\n\nfunction createMultipartStream(boundary, multipart) {\n  var finale = \"--\" + boundary + \"--\";\n  var stream = new stream_1.PassThrough();\n\n  for (var _i = 0, multipart_1 = multipart; _i < multipart_1.length; _i++) {\n    var part = multipart_1[_i];\n    var preamble = \"--\" + boundary + \"\\r\\nContent-Type: \" + part['Content-Type'] + \"\\r\\n\\r\\n\";\n    stream.write(preamble);\n\n    if (typeof part.body === 'string') {\n      stream.write(part.body);\n      stream.write('\\r\\n');\n    } else {\n      part.body.pipe(stream, {\n        end: false\n      });\n      part.body.on('end', function () {\n        stream.write('\\r\\n');\n        stream.write(finale);\n        stream.end();\n      });\n    }\n  }\n\n  return stream;\n}\n\nfunction teenyRequest(reqOpts, callback) {\n  var _a = requestToFetchOptions(reqOpts),\n      uri = _a.uri,\n      options = _a.options;\n\n  var multipart = reqOpts.multipart;\n\n  if (reqOpts.multipart && multipart.length === 2) {\n    if (!callback) {\n      // TODO: add support for multipart uploads through streaming\n      throw new Error('Multipart without callback is not implemented.');\n    }\n\n    var boundary = uuid.v4();\n    options.headers['Content-Type'] = \"multipart/related; boundary=\" + boundary;\n    options.body = createMultipartStream(boundary, multipart); // Multipart upload\n\n    node_fetch_1.default(uri, options).then(function (res) {\n      var header = res.headers.get('content-type');\n      var response = fetchToRequestResponse(options, res);\n      var body = response.body;\n\n      if (header === 'application/json' || header === 'application/json; charset=utf-8') {\n        res.json().then(function (json) {\n          response.body = json;\n          callback(null, response, json);\n        }, function (err) {\n          callback(err, response, body);\n        });\n        return;\n      }\n\n      res.text().then(function (text) {\n        response.body = text;\n        callback(null, response, text);\n      }, function (err) {\n        callback(err, response, body);\n      });\n    }, function (err) {\n      callback(err, null, null);\n    });\n    return;\n  }\n\n  if (callback === undefined) {\n    // Stream mode\n    var requestStream_1 = streamEvents(new stream_1.PassThrough()); // tslint:disable-next-line no-any\n\n    var responseStream_1;\n    requestStream_1.once('reading', function () {\n      if (responseStream_1) {\n        responseStream_1.pipe(requestStream_1);\n      } else {\n        requestStream_1.once('response', function () {\n          responseStream_1.pipe(requestStream_1);\n        });\n      }\n    });\n    options.compress = false;\n    node_fetch_1.default(uri, options).then(function (res) {\n      responseStream_1 = res.body;\n      responseStream_1.on('error', function (err) {\n        requestStream_1.emit('error', err);\n      });\n      var response = fetchToRequestResponse(options, res);\n      requestStream_1.emit('response', response);\n    }, function (err) {\n      requestStream_1.emit('error', err);\n    }); // fetch doesn't supply the raw HTTP stream, instead it\n    // returns a PassThrough piped from the HTTP response\n    // stream.\n\n    return requestStream_1;\n  } // GET or POST with callback\n\n\n  node_fetch_1.default(uri, options).then(function (res) {\n    var header = res.headers.get('content-type');\n    var response = fetchToRequestResponse(options, res);\n    var body = response.body;\n\n    if (header === 'application/json' || header === 'application/json; charset=utf-8') {\n      if (response.statusCode === 204) {\n        // Probably a DELETE\n        callback(null, response, body);\n        return;\n      }\n\n      res.json().then(function (json) {\n        response.body = json;\n        callback(null, response, json);\n      }, function (err) {\n        callback(err, response, body);\n      });\n      return;\n    }\n\n    res.text().then(function (text) {\n      var response = fetchToRequestResponse(options, res);\n      response.body = text;\n      callback(null, response, text);\n    }, function (err) {\n      callback(err, response, body);\n    });\n  }, function (err) {\n    callback(err, null, null);\n  });\n  return;\n}\n\nexports.teenyRequest = teenyRequest;\n\nteenyRequest.defaults = function (defaults) {\n  return function (reqOpts, callback) {\n    var opts = __assign(__assign({}, defaults), reqOpts);\n\n    if (callback === undefined) {\n      return teenyRequest(opts);\n    }\n\n    teenyRequest(opts, callback);\n  };\n};","map":{"version":3,"sources":["../../src/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\n/*!\n * Copyright 2018 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __assign = (this && this.__assign) || function () {\n    __assign = Object.assign || function(t) {\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\n            s = arguments[i];\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n                t[p] = s[p];\n        }\n        return t;\n    };\n    return __assign.apply(this, arguments);\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar node_fetch_1 = require(\"node-fetch\");\nvar stream_1 = require(\"stream\");\nvar uuid = require(\"uuid\");\nvar agents_1 = require(\"./agents\");\nvar streamEvents = require('stream-events');\nvar RequestError = /** @class */ (function (_super) {\n    __extends(RequestError, _super);\n    function RequestError() {\n        return _super !== null && _super.apply(this, arguments) || this;\n    }\n    return RequestError;\n}(Error));\nexports.RequestError = RequestError;\n/**\n * Convert options from Request to Fetch format\n * @private\n * @param reqOpts Request options\n */\nfunction requestToFetchOptions(reqOpts) {\n    var options = __assign(__assign({ method: reqOpts.method || 'GET' }, (reqOpts.timeout && { timeout: reqOpts.timeout })), (typeof reqOpts.gzip === 'boolean' && { compress: reqOpts.gzip }));\n    if (typeof reqOpts.json === 'object') {\n        // Add Content-type: application/json header\n        reqOpts.headers = reqOpts.headers || {};\n        reqOpts.headers['Content-Type'] = 'application/json';\n        // Set body to JSON representation of value\n        options.body = JSON.stringify(reqOpts.json);\n    }\n    else {\n        if (typeof reqOpts.body !== 'string') {\n            options.body = JSON.stringify(reqOpts.body);\n        }\n        else {\n            options.body = reqOpts.body;\n        }\n    }\n    // tslint:disable-next-line no-any\n    options.headers = reqOpts.headers;\n    var uri = (reqOpts.uri ||\n        reqOpts.url);\n    if (reqOpts.useQuerystring === true || typeof reqOpts.qs === 'object') {\n        var qs = require('querystring');\n        var params = qs.stringify(reqOpts.qs);\n        uri = uri + '?' + params;\n    }\n    options.agent = agents_1.getAgent(uri, reqOpts);\n    return { uri: uri, options: options };\n}\n/**\n * Convert a response from `fetch` to `request` format.\n * @private\n * @param opts The `request` options used to create the request.\n * @param res The Fetch response\n * @returns A `request` response object\n */\nfunction fetchToRequestResponse(opts, res) {\n    var request = {};\n    request.agent = opts.agent || false;\n    request.headers = (opts.headers || {});\n    request.href = res.url;\n    // headers need to be converted from a map to an obj\n    var resHeaders = {};\n    res.headers.forEach(function (value, key) { return (resHeaders[key] = value); });\n    var response = Object.assign(res.body, {\n        statusCode: res.status,\n        statusMessage: res.statusText,\n        request: request,\n        body: res.body,\n        headers: resHeaders,\n        toJSON: function () { return ({ headers: resHeaders }); },\n    });\n    return response;\n}\n/**\n * Create POST body from two parts as multipart/related content-type\n * @private\n * @param boundary\n * @param multipart\n */\nfunction createMultipartStream(boundary, multipart) {\n    var finale = \"--\" + boundary + \"--\";\n    var stream = new stream_1.PassThrough();\n    for (var _i = 0, multipart_1 = multipart; _i < multipart_1.length; _i++) {\n        var part = multipart_1[_i];\n        var preamble = \"--\" + boundary + \"\\r\\nContent-Type: \" + part['Content-Type'] + \"\\r\\n\\r\\n\";\n        stream.write(preamble);\n        if (typeof part.body === 'string') {\n            stream.write(part.body);\n            stream.write('\\r\\n');\n        }\n        else {\n            part.body.pipe(stream, { end: false });\n            part.body.on('end', function () {\n                stream.write('\\r\\n');\n                stream.write(finale);\n                stream.end();\n            });\n        }\n    }\n    return stream;\n}\nfunction teenyRequest(reqOpts, callback) {\n    var _a = requestToFetchOptions(reqOpts), uri = _a.uri, options = _a.options;\n    var multipart = reqOpts.multipart;\n    if (reqOpts.multipart && multipart.length === 2) {\n        if (!callback) {\n            // TODO: add support for multipart uploads through streaming\n            throw new Error('Multipart without callback is not implemented.');\n        }\n        var boundary = uuid.v4();\n        options.headers['Content-Type'] = \"multipart/related; boundary=\" + boundary;\n        options.body = createMultipartStream(boundary, multipart);\n        // Multipart upload\n        node_fetch_1.default(uri, options).then(function (res) {\n            var header = res.headers.get('content-type');\n            var response = fetchToRequestResponse(options, res);\n            var body = response.body;\n            if (header === 'application/json' ||\n                header === 'application/json; charset=utf-8') {\n                res.json().then(function (json) {\n                    response.body = json;\n                    callback(null, response, json);\n                }, function (err) {\n                    callback(err, response, body);\n                });\n                return;\n            }\n            res.text().then(function (text) {\n                response.body = text;\n                callback(null, response, text);\n            }, function (err) {\n                callback(err, response, body);\n            });\n        }, function (err) {\n            callback(err, null, null);\n        });\n        return;\n    }\n    if (callback === undefined) {\n        // Stream mode\n        var requestStream_1 = streamEvents(new stream_1.PassThrough());\n        // tslint:disable-next-line no-any\n        var responseStream_1;\n        requestStream_1.once('reading', function () {\n            if (responseStream_1) {\n                responseStream_1.pipe(requestStream_1);\n            }\n            else {\n                requestStream_1.once('response', function () {\n                    responseStream_1.pipe(requestStream_1);\n                });\n            }\n        });\n        options.compress = false;\n        node_fetch_1.default(uri, options).then(function (res) {\n            responseStream_1 = res.body;\n            responseStream_1.on('error', function (err) {\n                requestStream_1.emit('error', err);\n            });\n            var response = fetchToRequestResponse(options, res);\n            requestStream_1.emit('response', response);\n        }, function (err) {\n            requestStream_1.emit('error', err);\n        });\n        // fetch doesn't supply the raw HTTP stream, instead it\n        // returns a PassThrough piped from the HTTP response\n        // stream.\n        return requestStream_1;\n    }\n    // GET or POST with callback\n    node_fetch_1.default(uri, options).then(function (res) {\n        var header = res.headers.get('content-type');\n        var response = fetchToRequestResponse(options, res);\n        var body = response.body;\n        if (header === 'application/json' ||\n            header === 'application/json; charset=utf-8') {\n            if (response.statusCode === 204) {\n                // Probably a DELETE\n                callback(null, response, body);\n                return;\n            }\n            res.json().then(function (json) {\n                response.body = json;\n                callback(null, response, json);\n            }, function (err) {\n                callback(err, response, body);\n            });\n            return;\n        }\n        res.text().then(function (text) {\n            var response = fetchToRequestResponse(options, res);\n            response.body = text;\n            callback(null, response, text);\n        }, function (err) {\n            callback(err, response, body);\n        });\n    }, function (err) {\n        callback(err, null, null);\n    });\n    return;\n}\nexports.teenyRequest = teenyRequest;\nteenyRequest.defaults = function (defaults) {\n    return function (reqOpts, callback) {\n        var opts = __assign(__assign({}, defaults), reqOpts);\n        if (callback === undefined) {\n            return teenyRequest(opts);\n        }\n        teenyRequest(opts, callback);\n    };\n};\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"script"}